var fs=require("fs"),http=require("http"),https=require("https"),exec=require("child_process").exec,SM_ADDR="192.168.100.1",WINDOWS=(eval(fs.readFileSync("./public/utils.js")+""),"win32"==process.platform||"darwin"==process.platform),express=require("express"),app=express(),index_html,index_gz,server=(app.use(express.static("public",{index:"index.html"})),fs.existsSync("./index.html")&&fs.existsSync("./index.html.gz")?(index_html={},index_html.file=fs.readFileSync("./index.html"),index_html.stat=fs.statSync("./index.html"),index_html.etag=new Date(index_html.stat.mtime).getTime(),index_gz={},index_gz.file=fs.readFileSync("./index.html.gz"),index_gz.stat=fs.statSync("./index.html.gz"),index_gz.etag=new Date(index_gz.stat.mtime).getTime()+1,app.get("/",function(e,t){var s=ip_ending(e.ip),r=e.get("accept-encoding"),r=r&&0<=r.indexOf("gzip"),a=r?index_gz:index_html;t.setHeader("content-type","text/html; charset=utf-8"),t.setHeader("cache-control","public, max-age=1000000"),t.setHeader("content-length",a.stat.size),t.setHeader("etag",a.etag),r&&t.setHeader("content-encoding","gzip"),e.get("if-none-match")==a.etag?(log("["+s+"] loading from cache"),t.statusCode=304,t.end()):(log("["+s+"] loading page"+(r?"":" (uncompressed)")),t.end(a.file))})):log("*** SPECTATOR DEV MODE ***"),app.listen(PORT)),WebSocket=require("ws"),wss=new WebSocket.Server({server:server,perMessageDeflate:!1}),data=(socket_send_timeout=1e4,{}),data_ready=!1,session=(data.version="SPECTATOR",log("*** ShotMarker "+data.version+" ***"),uuid()),args=(data.args={},process.argv.slice(2));if(args.length)for(var i in args)data.args[args[i]]=!0;function logc(e,t){e&&e.ipaddr?log("["+ip_ending(e.ipaddr)+"] "+t):log("[?] "+t)}data.args.windows=WINDOWS,process.on("SIGINT",function(){console.log("exiting"),process.exit()}),wss.on("connection",function(t){t.ipaddr=t._socket.remoteAddress,logc(t,"connected"),socket_timeout[t.ipaddr]=0,t.on("message",function(e){socket_recv(t,e)}),t.on("close",function(e){logc(t,"disconnected")}),socket_emit(t,"session",{session:session,version:VERSION})}),socket_on("data",function(e,t){data_ready&&(socket_emit(e,"data",data),logc(e,"data #"+data.seq+" sent"))});var socket_requested={};function wsc_send(e){wsc.send(JSON.stringify(e))}socket_on("get_results",function(e){data_ready&&(logc(e,"requested results"),socket_requested.results||(socket_requested.results=[]),socket_requested.results.length||wsc_emit("get_results"),socket_requested.results.push(e))}),socket_on("get_archive",function(e){data_ready&&(logc(e,"requested archive"),socket_requested.archive||(socket_requested.archive=[]),socket_requested.archive.length||wsc_emit("get_archive"),socket_requested.archive.push(e))}),socket_on("get_string",function(e,t){data_ready&&Number(t)&&(logc(e,"requested string "+t),socket_requested[t]||(socket_requested[t]=[]),socket_requested[t].length||wsc_emit("get_string",t),socket_requested[t].push(e))}),log("spectator server ready on port "+PORT);var wsc=new WebSocket("ws://"+SM_ADDR);function wsc_emit(e,t){return wsc_emit_do(JSON.stringify({type:e,data:t}))}function wsc_emit_cache(e,t){return wsc_emit_do(socket,'{"type":"'+e+'","data":'+t+"}")}function wsc_emit_do(e){try{return wsc.send(e,function(e){e&&log("wsc send async error: "+e)}),1}catch(e){log("wsc send error: "+e)}return 0}wsc.on("error",function(e){log("socket error",e.code),process.exit(0)}),wsc.on("close",function(){log("socket close"),process.exit(0)}),wsc.on("open",function(){log("connected to primary server")}),wsc.on("message",function(t){var e;try{e=JSON.parse(t)}catch(e){return log("error parsing message",e),void log(t)}if(wsc.send("ack"),"session"==e.type&&wsc_emit("data"),"data"==e.type){(data=e.data).spectator=!0,data_ready||log("data ready"),data_ready=!0;var s=0;for(o in wss.clients){var r=wss.clients[o];s+=socket_emit_do(r,"data",t)}log("  data #"+data.seq+" sent to "+s)}if("delta"==e.type){if(!data_ready)return;var a=e.data,s=(update_object(data,a),0);for(o in wss.clients){r=wss.clients[o];s+=socket_emit_do(r,"delta",t)}}if("results"==e.type){s=0;for(o in socket_requested.results){r=socket_requested.results[o];s+=socket_emit_do(r,"results",t)}log("sent results to "+s),socket_requested.results=[]}if("archive"==e.type){s=0;for(o in socket_requested.archive){r=socket_requested.archive[o];s+=socket_emit_do(r,"archive",t)}log("sent archive to "+s),socket_requested.archive=[]}if("string"==e.type){var o,n=e.data.id,s=(log("got string",n),0);for(o in socket_requested[n]){r=socket_requested[n][o];s+=socket_emit_do(r,"string",t)}log("sent string to "+s),socket_requested[n]=[]}"message"==e.type&&e.data&&"clear_target"==e.data.msg_type&&(log("server cleared a target"),wsc_emit("data"))});